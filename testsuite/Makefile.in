modulesdir = @libdir@/ctrlproxy
LIBS = @LIBS@ @PKG_LIBS@ @PKG_CFLAGS@
CC = @CC@
CFLAGS = @CFLAGS@ @PKG_CFLAGS@ -I.. -DHAVE_CONFIG_H
INSTALL = @INSTALL@

CFLAGS+=-ansi -Wall -DMODULESDIR=\"$(modulesdir)\"

.PHONY: all clean distclean install

all: 

test-linestack: test-linestack.o ../line.o ../linestack.o ../transport.o ../plugins.o ../util.o
	$(CC) $(LIBS) -o $@ test-linestack.o ../line.o ../linestack.o ../transport.o ../plugins.o ../util.o

test-parser: test-parser.o ../line.o ../transport.o
	$(CC) $(LIBS) -o $@ test-parser.o ../line.o ../transport.o


test-filter: test-filter.o ../line.o ../transport.o ../plugins.o ../linestack.o ../util.o ../state.o 
	$(CC) $(LIBS) -o $@ test-filter.o ../line.o ../transport.o ../plugins.o ../linestack.o ../util.o ../state.o 

%.o: %.c
	$(CC) $(CFLAGS) -c $<

install: 

clean:
	rm -f *.o test-parser *.out *.tmp

distclean: clean
	rm -f Makefile 

tests: test1 test2 test3

test1: test-parser
	@# Check to see whether the parser can handle all kinds of nifty 
	@# input without crashing
	@echo -n Test1: 
	@dd if=/dev/urandom of=random.in count=300 2>/dev/null > /dev/null
	@./test-parser < random.in 2>/dev/null > /dev/null
	@echo OK
	
test2: test-parser
	@# Check for some other data that might crash the parser
	@echo -n Test2: 
	@./test-parser < test1.data 2>/dev/null > test1.data.out
	@echo OK

test3.data.%.out: ../mods/lib%.so test-filter
	@echo -n Test3-$(patsubst test3.data.%.out,%:,$@)
	@./test-filter `pwd`/$< < test3.data > $@.tmp
	@echo OK
	@mv $@.tmp $@

TEST3_MODULES = ctcp log_custom log_irssi repl_command repl_highlight repl_lastdisconnect repl_limited repl_simple report_time debug auto-away antiflood admin

test3: test-filter $(patsubst %,test3.data.%.out,$(TEST3_MODULES))
	@# Run all modules for which this is possible thru the test data files

LINESTACK_MODULES = linestack_file linestack_memory

test-linestack_%: ../mods/liblinestack_%.so test-linestack
	@echo -n Test 4-$(patsubst test-linestack_%,%:,%@)
	@./test-linestack `pwd`/$< < test1.data > $@.tmp
	@cmp $@.tmp test1.data
	@echo OK

test4: test-linestack $(patsubst %,test-%,$(LINESTACK_MODULES))
