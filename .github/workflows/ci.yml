name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    name: Build and test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y check libgnutls28-dev libkrb5-dev libglib2.0-dev libgcrypt20-dev autoconf automake libtool pkg-config

    - name: Generate configure script
      run: ./autogen.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make

    - name: Run tests
      run: make check

    - name: Show test logs on failure
      if: failure()
      run: |
        if [ -f testsuite/check.log ]; then
          cat testsuite/check.log
        fi
        if [ -f test-suite.log ]; then
          cat test-suite.log
        fi
